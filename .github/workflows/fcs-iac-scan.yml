name: FCS IaC Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  fcs-iac-scan:
    name: Run FCS IaC scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run FCS IaC Scan
        id: fcs_scan
        uses: crowdstrike/fcs-action@v2.0.2
        with:
          # Either supply the client id directly or reference a repo variable (recommended):
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}   # or ${{ vars.FALCON_CLIENT_ID }}
          falcon_region: 'us-1'                              # set the region for your tenant
          scan_type: 'iac'                                   # iac or image
          path: './infrastructure'                           # path to IaC (file/dir/git::repo)
          report_formats: 'sarif'                            # request SARIF for GH Code Scanning
          output_path: './fcs-results'                       # must be a directory for IaC scan
          fail_on: 'critical=1,high=1'                       # fail job if criteria met (customize)
        env:
          FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

      - name: Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ./fcs-results/results.sarif   # adjust if FCS writes a different filename

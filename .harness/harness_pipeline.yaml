pipeline:
  name: JuiceShop - FCS Harness.io Pipeline
  identifier: JuiceShop_FCS_Pipeline
  projectIdentifier: default_project
  orgIdentifier: default
  tags: {}
  properties:
    ci:
      codebase:
        connectorRef: GITHUB
        repoName: juice-shopv21
        build:
          type: branch
          spec:
            branch: main
  variables:
    - name: JUICE_SHOP_REPO
      type: String
      description: ""
      required: false
      value: https://github.com/mile9299/juice-shopv21.git
    - name: DOCKER_PORT
      type: String
      description: ""
      required: false
      value: "3000"
    - name: CS_IMAGE_NAME
      type: String
      description: ""
      required: false
      value: mile/spooky
    - name: CS_IMAGE_TAG
      type: String
      description: ""
      required: false
      value: latest
    - name: DOCKER_USERNAME
      type: String
      description: ""
      required: false
      value: mile
    - name: FALCON_REGION
      type: String
      description: ""
      required: false
      value: us-1
    - name: PROJECT_PATH
      type: String
      description: ""
      required: false
      value: .
    - name: FCS_SCANNER_IMAGE
      type: String
      description: ""
      required: false
      value: mile/cs-fcs
    - name: FCS_SCANNER_TAG
      type: String
      description: ""
      required: false
      value: 2.1.5
    - name: FALCON_CLIENT_ID
      type: String
      description: ""
      required: false
      value: <+secrets.getValue("account.FALCON_CLIENT_ID")>
    - name: FALCON_CLIENT_SECRET
      type: String
      description: ""
      required: false
      value: <+secrets.getValue("account.FALCON_CLIENT_SECRET")>
  stages:
    - stage:
        name: Build and Scan Stage
        identifier: build_stage
        description: ""
        type: CI
        spec:
          cloneCodebase: true
          infrastructure:
            type: KubernetesDirect
            spec:
              connectorRef: <+input>
              namespace: harness-delegate-ng
              automountServiceAccountToken: true
              nodeSelector: {}
              os: Linux
          sharedPaths:
            - /harness/scan-results
          execution:
            steps:
              - step:
                  type: Run
                  name: CrowdStrike IaC Scan
                  identifier: crowdstrike_iac_scan
                  spec:
                    connectorRef: account.harnessImage
                    image: docker:24-dind
                    shell: Sh
                    command: |-
                      set +x
                      echo "Starting CrowdStrike IaC Scan..."

                      dockerd-entrypoint.sh &
                      DOCKER_PID=$!

                      for i in $(seq 1 30); do
                        if docker info >/dev/null 2>&1; then
                          echo "✓ Docker daemon is ready"
                          break
                        fi
                        sleep 2
                      done

                      if ! docker info >/dev/null 2>&1; then
                        echo "Error: Docker daemon failed to start"
                        exit 1
                      fi

                      echo "$DOCKERHUB_PASSWORD" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin

                      SCANNER_IMAGE="${FCS_SCANNER_IMAGE}:${FCS_SCANNER_TAG}"
                      docker pull "$SCANNER_IMAGE"

                      echo "=============== FCS IaC Scan Starts ==============="

                      set +e
                      docker run --network=host --rm \
                        -v "$(pwd):/scan" \
                        -w /scan \
                        -e FALCON_CLIENT_ID="$FALCON_CLIENT_ID" \
                        -e FALCON_CLIENT_SECRET="$FALCON_CLIENT_SECRET" \
                        -e FALCON_CLOUD_REGION="$FALCON_REGION" \
                        "$SCANNER_IMAGE" \
                        --client-id "$FALCON_CLIENT_ID" \
                        --client-secret "$FALCON_CLIENT_SECRET" \
                        --falcon-region "$FALCON_REGION" \
                        iac scan -p "$PROJECT_PATH" --upload-results > scansummary.txt 2>&1

                      scan_status=$?
                      set -e

                      cat scansummary.txt

                      # Copy to shared path
                      mkdir -p /harness/scan-results
                      cp scansummary.txt /harness/scan-results/ 2>/dev/null || true

                      echo "=============== FCS IaC Scan Ends ==============="
                      echo "Scan status: $scan_status"

                      kill $DOCKER_PID 2>/dev/null || true

                      export SCAN_STATUS="success"
                    privileged: true
                    envVariables:
                      DOCKERHUB_USERNAME: <+pipeline.variables.DOCKER_USERNAME>
                      DOCKERHUB_PASSWORD: <+secrets.getValue("account.dockerhub_password")>
                      FCS_SCANNER_IMAGE: <+pipeline.variables.FCS_SCANNER_IMAGE>
                      FCS_SCANNER_TAG: <+pipeline.variables.FCS_SCANNER_TAG>
                      FALCON_CLIENT_ID: <+secrets.getValue("account.cs_username")>
                      FALCON_CLIENT_SECRET: <+secrets.getValue("account.cs_password")>
                      FALCON_REGION: <+pipeline.variables.FALCON_REGION>
                      PROJECT_PATH: <+pipeline.variables.PROJECT_PATH>
                    outputVariables:
                      - name: SCAN_STATUS
                  timeout: 20m
              - step:
                  type: Run
                  name: Process IaC Scan Results
                  identifier: process_iac_results
                  spec:
                    connectorRef: account.harnessImage
                    image: alpine
                    shell: Sh
                    command: |-
                      apk add --no-cache jq

                      echo "=== Processing IaC Scan Results ==="

                      # Check shared path first
                      if [ -f /harness/scan-results/scansummary.txt ]; then
                        cp /harness/scan-results/scansummary.txt .
                      fi

                      if [ ! -f scansummary.txt ]; then
                        echo "No scan summary found"
                        export FINDINGS_COUNT=0
                        export CRITICAL_FINDINGS=0
                        export HIGH_FINDINGS=0
                        export MEDIUM_FINDINGS=0
                        export LOW_FINDINGS=0
                        exit 0
                      fi

                      cat scansummary.txt

                      TOTAL=$(grep "Total:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
                      CRITICAL=$(grep "Critical:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
                      HIGH=$(grep "High:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
                      MEDIUM=$(grep "Medium:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
                      INFORMATIONAL=$(grep "Informational:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)

                      echo ""
                      echo "=== IaC Scan Summary ==="
                      echo "Total: $TOTAL | Critical: $CRITICAL | High: $HIGH | Medium: $MEDIUM | Info: $INFORMATIONAL"

                      export FINDINGS_COUNT=$TOTAL
                      export CRITICAL_FINDINGS=$CRITICAL
                      export HIGH_FINDINGS=$HIGH
                      export MEDIUM_FINDINGS=$MEDIUM
                      export LOW_FINDINGS=$INFORMATIONAL
                    outputVariables:
                      - name: FINDINGS_COUNT
                      - name: CRITICAL_FINDINGS
                      - name: HIGH_FINDINGS
                      - name: MEDIUM_FINDINGS
                      - name: LOW_FINDINGS
                  timeout: 5m
              - step:
                  type: Run
                  name: Build Container Image with Docker
                  identifier: build_container_image_docker
                  spec:
                    connectorRef: account.harnessImage
                    image: docker:24-dind
                    shell: Sh
                    command: |-
                      set +x
                      echo "Building container image..."

                      dockerd-entrypoint.sh &
                      DOCKER_PID=$!

                      for i in $(seq 1 30); do
                        if docker info >/dev/null 2>&1; then
                          echo "✓ Docker daemon is ready"
                          break
                        fi
                        sleep 2
                      done

                      if ! docker info >/dev/null 2>&1; then
                        echo "Error: Docker daemon failed to start"
                        exit 1
                      fi

                      # Login to Docker Hub
                      echo "$DOCKERHUB_PASSWORD" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin

                      # Build the image
                      echo "Building image: ${CONTAINER_REPO}:${CONTAINER_TAG}"
                      docker build -t "${CONTAINER_REPO}:${CONTAINER_TAG}" -f Dockerfile .

                      if [ $? -eq 0 ]; then
                        echo "✓ Container image built successfully"
                        
                        # Push the image
                        echo "Pushing image to Docker Hub..."
                        docker push "${CONTAINER_REPO}:${CONTAINER_TAG}"
                        
                        if [ $? -eq 0 ]; then
                          echo "✓ Image pushed successfully"
                          export BUILD_STATUS="success"
                        else
                          echo "✗ Image push failed"
                          export BUILD_STATUS="push_failed"
                        fi
                      else
                        echo "✗ Container image build failed"
                        export BUILD_STATUS="failed"
                      fi

                      kill $DOCKER_PID 2>/dev/null || true
                    privileged: true
                    envVariables:
                      DOCKERHUB_USERNAME: <+pipeline.variables.DOCKER_USERNAME>
                      DOCKERHUB_PASSWORD: <+secrets.getValue("account.dockerhub_password")>
                      CONTAINER_REPO: <+pipeline.variables.CS_IMAGE_NAME>
                      CONTAINER_TAG: <+pipeline.variables.CS_IMAGE_TAG>
                    outputVariables:
                      - name: BUILD_STATUS
                  timeout: 15m
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              - step:
                  type: Run
                  name: Scan CrowdStrike Container Image Scan
                  identifier: scan_container_image_python
                  spec:
                    connectorRef: account.harnessImage
                    image: python:3.9-slim
                    shell: Bash
                    command: |-
                      set +x
                      echo "Starting CrowdStrike Container Image Scan..."

                      # Create shared results directory
                      mkdir -p /harness/scan-results

                      # Install required system packages
                      echo "Installing system dependencies..."
                      apt-get update && apt-get install -y \
                        git \
                        jq \
                        docker.io \
                        ca-certificates \
                        curl

                      # Install Python packages - ONLY Docker library (no podman)
                      echo "Installing Python dependencies..."
                      pip3 install --no-cache-dir --upgrade pip
                      pip3 install --no-cache-dir \
                        docker \
                        crowdstrike-falconpy \
                        retry

                      # Start Docker daemon in background
                      echo "Starting Docker daemon..."
                      dockerd > /var/log/dockerd.log 2>&1 &
                      DOCKER_PID=$!

                      # Wait for Docker to be ready
                      echo "Waiting for Docker daemon to start..."
                      for i in $(seq 1 45); do
                        if docker info >/dev/null 2>&1; then
                          echo "✓ Docker daemon is ready"
                          break
                        fi
                        if [ $i -eq 45 ]; then
                          echo "Error: Docker daemon failed to start after 90 seconds"
                          echo "Docker daemon logs:"
                          cat /var/log/dockerd.log || echo "No logs available"
                          
                          # Set default values and exit gracefully
                          export TOTAL_VULNERABILITIES=0
                          export CRITICAL_VULNERABILITIES=0
                          export HIGH_VULNERABILITIES=0
                          export SECRETS_FOUND="false"
                          
                          echo "0" > /harness/scan-results/total_vulns.txt
                          echo "0" > /harness/scan-results/critical_vulns.txt
                          echo "0" > /harness/scan-results/high_vulns.txt
                          echo "false" > /harness/scan-results/secrets_found.txt
                          
                          exit 0
                        fi
                        sleep 2
                      done

                      # Verify Docker is working
                      echo "Verifying Docker installation..."
                      docker --version
                      docker info

                      # Login to Docker Hub if credentials are provided
                      if [ -n "$DOCKERHUB_USERNAME" ] && [ -n "$DOCKERHUB_PASSWORD" ]; then
                        echo "Logging into Docker Hub..."
                        echo "$DOCKERHUB_PASSWORD" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin
                      fi

                      # Pull the image to scan
                      echo "Pulling image to scan: ${IMAGE_NAME}:${IMAGE_TAG}"
                      docker pull "${IMAGE_NAME}:${IMAGE_TAG}" || {
                        echo "Warning: Failed to pull image, it may already exist locally or be inaccessible"
                      }

                      # Clone the container-image-scan repository
                      echo "Cloning CrowdStrike container-image-scan repository..."
                      if [ ! -d container-image-scan ]; then
                        git clone https://github.com/crowdstrike/container-image-scan
                      fi

                      # Set environment variables for the scan
                      export FALCON_CLIENT_SECRET="$FALCON_CLIENT_SECRET"
                      export FALCON_CLIENT_ID="$FALCON_CLIENT_ID"
                      export FALCON_CLOUD_REGION="$FALCON_REGION"

                      # Prepare image details
                      IMAGE_REPO="$IMAGE_NAME"
                      IMAGE_TAG_VALUE="$IMAGE_TAG"

                      echo ""
                      echo "=== Scan Configuration ==="
                      echo "Image: ${IMAGE_REPO}:${IMAGE_TAG_VALUE}"
                      echo "Region: $FALCON_REGION"
                      echo "Client ID: (hidden for security)"
                      echo "=========================="
                      echo ""

                      # Verify Python can import docker module
                      echo "Verifying Python Docker module..."
                      python3 -c "import docker; print(f'Docker module version: {docker.__version__}')" || {
                        echo "Error: Failed to import docker module"
                        export TOTAL_VULNERABILITIES=0
                        export CRITICAL_VULNERABILITIES=0
                        export HIGH_VULNERABILITIES=0
                        export SECRETS_FOUND="false"
                        
                        echo "0" > /harness/scan-results/total_vulns.txt
                        echo "0" > /harness/scan-results/critical_vulns.txt
                        echo "0" > /harness/scan-results/high_vulns.txt
                        echo "false" > /harness/scan-results/secrets_found.txt
                        
                        exit 0
                      }

                      # Run the scan (don't fail on non-zero exit)
                      echo "Running container image scan..."
                      set +e
                      python3 container-image-scan/cs_scanimage.py \
                        --repo "$IMAGE_REPO" \
                        --tag "$IMAGE_TAG_VALUE" \
                        --cloud-region "$FALCON_REGION" \
                        --json-report report.json
                      scan_exit_code=$?
                      set -e

                      echo ""
                      echo "Scan completed with exit code: $scan_exit_code"

                      # Cleanup Docker daemon
                      echo "Stopping Docker daemon..."
                      kill $DOCKER_PID 2>/dev/null || true
                      wait $DOCKER_PID 2>/dev/null || true

                      # Process the report
                      if [ -f "report.json" ]; then
                        echo "✓ Scan report generated"
                        
                        # Copy report to shared path
                        cp report.json /harness/scan-results/
                        
                        # Display report
                        echo ""
                        echo "=== Scan Report ==="
                        cat report.json | jq '.' || cat report.json
                        
                        # Create remediation plan
                        echo "# Vulnerability Remediation Plan" > remediation_plan.md
                        echo "" >> remediation_plan.md
                        echo "Generated: $(date)" >> remediation_plan.md
                        echo "Image: ${IMAGE_REPO}:${IMAGE_TAG_VALUE}" >> remediation_plan.md
                        echo "" >> remediation_plan.md
                        
                        # Check for vulnerabilities
                        if jq -e '.vulnerabilities' report.json > /dev/null 2>&1; then
                          echo ""
                          echo "Vulnerabilities found in the image:"
                          jq -r '.vulnerabilities[] | select(.severity == "HIGH" or .severity == "CRITICAL") | "- \(.severity): \(.cve_id) in \(.package_name) \(.package_version)"' report.json || true
                          
                          echo "## High and Critical Vulnerabilities" >> remediation_plan.md
                          jq -r '.vulnerabilities[] | select(.severity == "HIGH" or .severity == "CRITICAL") | "- **\(.severity)**: \(.cve_id) in \(.package_name) \(.package_version)\n  - Description: \(.description // "N/A")\n  - Remediation: Update to latest version or apply patch\n"' report.json >> remediation_plan.md || true
                          
                          # Count vulnerabilities
                          TOTAL_VULNS=$(jq '[.vulnerabilities[]] | length' report.json || echo 0)
                          CRITICAL_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' report.json || echo 0)
                          HIGH_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "HIGH")] | length' report.json || echo 0)
                          MEDIUM_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "MEDIUM")] | length' report.json || echo 0)
                          
                          echo ""
                          echo "Vulnerability Summary:"
                          echo "  Total: $TOTAL_VULNS"
                          echo "  Critical: $CRITICAL_VULNS"
                          echo "  High: $HIGH_VULNS"
                          echo "  Medium: $MEDIUM_VULNS"
                          
                          export TOTAL_VULNERABILITIES=$TOTAL_VULNS
                          export CRITICAL_VULNERABILITIES=$CRITICAL_VULNS
                          export HIGH_VULNERABILITIES=$HIGH_VULNS
                          
                          # Save to shared path
                          echo "$TOTAL_VULNS" > /harness/scan-results/total_vulns.txt
                          echo "$CRITICAL_VULNS" > /harness/scan-results/critical_vulns.txt
                          echo "$HIGH_VULNS" > /harness/scan-results/high_vulns.txt
                        else
                          echo "No vulnerabilities found"
                          export TOTAL_VULNERABILITIES=0
                          export CRITICAL_VULNERABILITIES=0
                          export HIGH_VULNERABILITIES=0
                          
                          echo "0" > /harness/scan-results/total_vulns.txt
                          echo "0" > /harness/scan-results/critical_vulns.txt
                          echo "0" > /harness/scan-results/high_vulns.txt
                        fi
                        
                        # Check for secrets
                        if jq -e '.secrets' report.json > /dev/null 2>&1; then
                          echo ""
                          echo "WARNING: Secrets were detected in the image:"
                          jq -r '.secrets[] | "- Secret type: \(.type) in \(.path)"' report.json || true
                          
                          echo "" >> remediation_plan.md
                          echo "## Detected Secrets" >> remediation_plan.md
                          jq -r '.secrets[] | "- Secret type: \(.type) found in \(.path)\n  - Action: Remove this secret and use secure storage methods instead\n"' report.json >> remediation_plan.md || true
                          
                          export SECRETS_FOUND="true"
                          echo "true" > /harness/scan-results/secrets_found.txt
                        else
                          echo "No secrets were detected in the image"
                          export SECRETS_FOUND="false"
                          echo "false" > /harness/scan-results/secrets_found.txt
                        fi
                        
                        # Copy remediation plan to shared path
                        cp remediation_plan.md /harness/scan-results/
                        
                        # Display remediation plan
                        echo ""
                        echo "=== Remediation Plan ==="
                        cat remediation_plan.md
                        
                      else
                        echo "Error: Scan report not generated"
                        echo "# No security findings to report" > remediation_plan.md
                        cp remediation_plan.md /harness/scan-results/
                        
                        export TOTAL_VULNERABILITIES=0
                        export CRITICAL_VULNERABILITIES=0
                        export HIGH_VULNERABILITIES=0
                        export SECRETS_FOUND="false"
                        
                        echo "0" > /harness/scan-results/total_vulns.txt
                        echo "0" > /harness/scan-results/critical_vulns.txt
                        echo "0" > /harness/scan-results/high_vulns.txt
                        echo "false" > /harness/scan-results/secrets_found.txt
                      fi

                      echo ""
                      echo "✓ Container image scan completed"
                    privileged: true
                    envVariables:
                      FALCON_CLIENT_ID: <+secrets.getValue("account.cs_username")>
                      FALCON_CLIENT_SECRET: <+secrets.getValue("account.cs_password")>
                      FALCON_REGION: <+pipeline.variables.FALCON_REGION>
                      IMAGE_NAME: <+pipeline.variables.CS_IMAGE_NAME>
                      IMAGE_TAG: <+pipeline.variables.CS_IMAGE_TAG>
                      DOCKERHUB_USERNAME: <+pipeline.variables.DOCKER_USERNAME>
                      DOCKERHUB_PASSWORD: <+secrets.getValue("account.dockerhub_password")>
                    outputVariables:
                      - name: TOTAL_VULNERABILITIES
                      - name: CRITICAL_VULNERABILITIES
                      - name: HIGH_VULNERABILITIES
                      - name: SECRETS_FOUND
                  timeout: 15m
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              - step:
                  type: Run
                  name: Process Container Scan Results
                  identifier: process_container_results
                  spec:
                    connectorRef: account.harnessImage
                    image: alpine
                    shell: Sh
                    command: |-
                      apk add --no-cache jq

                      echo "=== Processing Container Scan Results ==="

                      # Check if report exists in shared path
                      if [ -f /harness/scan-results/report.json ]; then
                        cp /harness/scan-results/report.json .
                      fi

                      if [ ! -f report.json ]; then
                        echo "No scan report found, checking for saved results..."
                        
                        # Try to read from saved files
                        if [ -f /harness/scan-results/total_vulns.txt ]; then
                          TOTAL=$(cat /harness/scan-results/total_vulns.txt)
                          CRITICAL=$(cat /harness/scan-results/critical_vulns.txt)
                          HIGH=$(cat /harness/scan-results/high_vulns.txt)
                          SECRETS_DETECTED=$(cat /harness/scan-results/secrets_found.txt)
                        else
                          echo "No saved results found either"
                          TOTAL=0
                          CRITICAL=0
                          HIGH=0
                          SECRETS_DETECTED="false"
                        fi
                      else
                        # Display report summary
                        echo "Scan Report Summary:"
                        cat report.json | jq '.' || cat report.json

                        # Parse vulnerabilities
                        TOTAL=$(jq '[.vulnerabilities[]] | length' report.json 2>/dev/null || echo 0)
                        CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' report.json 2>/dev/null || echo 0)
                        HIGH=$(jq '[.vulnerabilities[] | select(.severity == "HIGH")] | length' report.json 2>/dev/null || echo 0)
                        MEDIUM=$(jq '[.vulnerabilities[] | select(.severity == "MEDIUM")] | length' report.json 2>/dev/null || echo 0)

                        # Check for secrets
                        SECRETS=$(jq '[.secrets[]] | length' report.json 2>/dev/null || echo 0)
                        if [ "$SECRETS" -gt 0 ]; then
                          SECRETS_DETECTED="true"
                        else
                          SECRETS_DETECTED="false"
                        fi
                      fi

                      echo ""
                      echo "=== Container Scan Summary ==="
                      echo "Total Vulnerabilities: $TOTAL"
                      echo "Critical: $CRITICAL"
                      echo "High: $HIGH"
                      echo "Secrets Detected: $SECRETS_DETECTED"

                      export VULNERABILITIES=$TOTAL
                      export CRITICAL_VULNS=$CRITICAL
                      export HIGH_VULNS=$HIGH
                      export SECRETS_DETECTED=$SECRETS_DETECTED
                    outputVariables:
                      - name: VULNERABILITIES
                      - name: CRITICAL_VULNS
                      - name: HIGH_VULNS
                      - name: SECRETS_DETECTED
                  timeout: 5m
              - step:
                  type: Run
                  name: Verify Application Dependencies
                  identifier: verify_app_dependencies
                  spec:
                    connectorRef: account.harnessImage
                    image: node:18-alpine
                    shell: Sh
                    command: |-
                      echo "Verifying Juice Shop application..."

                      # Check if package.json exists
                      if [ ! -f package.json ]; then
                        echo "Error: package.json not found"
                        export APP_READY="false"
                        exit 0
                      fi

                      echo "Installing dependencies..."
                      npm install --production

                      # Check available scripts
                      echo ""
                      echo "Available npm scripts:"
                      npm run 2>&1 | grep -A 100 "Lifecycle scripts" || echo "No scripts found"

                      # Run npm audit to show vulnerabilities
                      echo ""
                      echo "Running security audit..."
                      npm audit --production || true

                      echo ""
                      echo "✓ Application dependencies verified"
                      echo "Note: Application is containerized and runs via Docker"
                      export APP_READY="true"
                    envVariables:
                      DOCKER_PORT: <+pipeline.variables.DOCKER_PORT>
                    outputVariables:
                      - name: APP_READY
                  timeout: 10m
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              - step:
                  type: Run
                  name: Security Summary Report
                  identifier: security_summary
                  spec:
                    connectorRef: account.harnessImage
                    image: alpine
                    shell: Sh
                    command: |-
                      echo "========================================="
                      echo "  CROWDSTRIKE SECURITY SCAN SUMMARY"
                      echo "========================================="
                      echo ""
                      echo "Pipeline: <+pipeline.name>"
                      echo "Execution: <+pipeline.executionId>"
                      echo "Scanner: mile/cs-fcs:2.1.5"
                      echo "Image Scanned: <+pipeline.variables.CS_IMAGE_NAME>:<+pipeline.variables.CS_IMAGE_TAG>"
                      echo ""
                      echo "----------------------------------------"
                      echo "IaC Scan Results:"
                      echo "----------------------------------------"
                      echo "  Total Findings: <+execution.steps.process_iac_results.output.outputVariables.FINDINGS_COUNT>"
                      echo "  Critical: <+execution.steps.process_iac_results.output.outputVariables.CRITICAL_FINDINGS>"
                      echo "  High: <+execution.steps.process_iac_results.output.outputVariables.HIGH_FINDINGS>"
                      echo "  Medium: <+execution.steps.process_iac_results.output.outputVariables.MEDIUM_FINDINGS>"
                      echo "  Informational: <+execution.steps.process_iac_results.output.outputVariables.LOW_FINDINGS>"
                      echo ""
                      echo "----------------------------------------"
                      echo "Container Image Scan Results:"
                      echo "----------------------------------------"
                      echo "  Total Vulnerabilities: <+execution.steps.process_container_results.output.outputVariables.VULNERABILITIES>"
                      echo "  Critical: <+execution.steps.process_container_results.output.outputVariables.CRITICAL_VULNS>"
                      echo "  High: <+execution.steps.process_container_results.output.outputVariables.HIGH_VULNS>"
                      echo "  Secrets Detected: <+execution.steps.process_container_results.output.outputVariables.SECRETS_DETECTED>"
                      echo ""
                      echo "----------------------------------------"
                      echo "Build & Deployment Status:"
                      echo "----------------------------------------"
                      echo "  Build Status: <+execution.steps.build_container_image_docker.output.outputVariables.BUILD_STATUS>"
                      echo "  App Ready: <+execution.steps.verify_app_dependencies.output.outputVariables.APP_READY>"
                      echo ""
                      echo "========================================="
                      echo ""

                      # Check if remediation plan exists in shared path
                      if [ -f /harness/scan-results/remediation_plan.md ]; then
                        echo "Remediation Plan:"
                        echo "----------------------------------------"
                        cat /harness/scan-results/remediation_plan.md
                      fi

                      echo ""
                      echo "========================================="
                      echo "Pipeline execution completed successfully"
                      echo "========================================="
                  timeout: 2m
                  

version: 2.1

# Define reusable executors
executors:
  docker-executor:
    docker:
      - image: docker:24-dind
    resource_class: medium
  
  python-executor:
    docker:
      - image: python:3.9-slim
    resource_class: medium
  
  node-executor:
    docker:
      - image: node:18-alpine
    resource_class: medium
  
  alpine-executor:
    docker:
      - image: alpine:latest
    resource_class: small

# Define the workflow
workflows:
  version: 2
  juice-shop-fcs-pipeline:
    jobs:
      - crowdstrike-iac-scan
      - process-iac-results:
          requires:
            - crowdstrike-iac-scan
      - build-container-image:
          requires:
            - process-iac-results
      - scan-container-image:
          requires:
            - build-container-image
      - process-container-results:
          requires:
            - scan-container-image
      - verify-app-dependencies:
          requires:
            - process-container-results
      - security-summary:
          requires:
            - verify-app-dependencies

# Define jobs
jobs:
  crowdstrike-iac-scan:
    executor: docker-executor
    environment:
      JUICE_SHOP_REPO: https://github.com/mile9299/juice-shopv21.git
      DOCKER_PORT: "3000"
      CS_IMAGE_NAME: mile/spooky
      CS_IMAGE_TAG: latest
      DOCKER_USERNAME: mile
      FALCON_REGION: us-1
      PROJECT_PATH: .
      FCS_SCANNER_IMAGE: mile/cs-fcs
      FCS_SCANNER_TAG: 2.1.5
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - run:
          name: CrowdStrike IaC Scan
          no_output_timeout: 20m
          command: |
            set +x
            echo "Starting CrowdStrike IaC Scan..."

            # Wait for Docker daemon
            for i in $(seq 1 30); do
              if docker info >/dev/null 2>&1; then
                echo "✓ Docker daemon is ready"
                break
              fi
              sleep 2
            done

            if ! docker info >/dev/null 2>&1; then
              echo "Error: Docker daemon failed to start"
              exit 1
            fi

            echo "$DOCKERHUB_PASSWORD" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin

            SCANNER_IMAGE="${FCS_SCANNER_IMAGE}:${FCS_SCANNER_TAG}"
            docker pull "$SCANNER_IMAGE"

            echo "=============== FCS IaC Scan Starts ==============="

            set +e
            docker run --network=host --rm \
              -v "$(pwd):/scan" \
              -w /scan \
              -e FALCON_CLIENT_ID="$FALCON_CLIENT_ID" \
              -e FALCON_CLIENT_SECRET="$FALCON_CLIENT_SECRET" \
              -e FALCON_CLOUD_REGION="$FALCON_REGION" \
              "$SCANNER_IMAGE" \
              --client-id "$FALCON_CLIENT_ID" \
              --client-secret "$FALCON_CLIENT_SECRET" \
              --falcon-region "$FALCON_REGION" \
              iac scan -p "$PROJECT_PATH" --upload-results > scansummary.txt 2>&1

            scan_status=$?
            set -e

            cat scansummary.txt

            echo "=============== FCS IaC Scan Ends ==============="
            echo "Scan status: $scan_status"

            echo "success" > /tmp/scan_status.txt
      - persist_to_workspace:
          root: .
          paths:
            - scansummary.txt
            - /tmp/scan_status.txt

  process-iac-results:
    executor: alpine-executor
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Process IaC Scan Results
          command: |
            apk add --no-cache jq

            echo "=== Processing IaC Scan Results ==="

            if [ ! -f scansummary.txt ]; then
              echo "No scan summary found"
              echo "0" > /tmp/findings_count.txt
              echo "0" > /tmp/critical_findings.txt
              echo "0" > /tmp/high_findings.txt
              echo "0" > /tmp/medium_findings.txt
              echo "0" > /tmp/low_findings.txt
              exit 0
            fi

            cat scansummary.txt

            TOTAL=$(grep "Total:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
            CRITICAL=$(grep "Critical:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
            HIGH=$(grep "High:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
            MEDIUM=$(grep "Medium:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)
            INFORMATIONAL=$(grep "Informational:" scansummary.txt | grep -oE '[0-9]+' | head -1 || echo 0)

            echo ""
            echo "=== IaC Scan Summary ==="
            echo "Total: $TOTAL | Critical: $CRITICAL | High: $HIGH | Medium: $MEDIUM | Info: $INFORMATIONAL"

            echo "$TOTAL" > /tmp/findings_count.txt
            echo "$CRITICAL" > /tmp/critical_findings.txt
            echo "$HIGH" > /tmp/high_findings.txt
            echo "$MEDIUM" > /tmp/medium_findings.txt
            echo "$INFORMATIONAL" > /tmp/low_findings.txt
      - persist_to_workspace:
          root: /tmp
          paths:
            - findings_count.txt
            - critical_findings.txt
            - high_findings.txt
            - medium_findings.txt
            - low_findings.txt

  build-container-image:
    executor: docker-executor
    environment:
      DOCKER_USERNAME: mile
      CS_IMAGE_NAME: mile/spooky
      CS_IMAGE_TAG: latest
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - run:
          name: Build Container Image with Docker
          no_output_timeout: 15m
          command: |
            set +x
            echo "Building container image..."

            # Wait for Docker daemon
            for i in $(seq 1 30); do
              if docker info >/dev/null 2>&1; then
                echo "✓ Docker daemon is ready"
                break
              fi
              sleep 2
            done

            if ! docker info >/dev/null 2>&1; then
              echo "Error: Docker daemon failed to start"
              exit 1
            fi

            # Login to Docker Hub
            echo "$DOCKERHUB_PASSWORD" | docker login docker.io --username "$DOCKER_USERNAME" --password-stdin

            # Build the image
            echo "Building image: ${CS_IMAGE_NAME}:${CS_IMAGE_TAG}"
            docker build -t "${CS_IMAGE_NAME}:${CS_IMAGE_TAG}" -f Dockerfile .

            if [ $? -eq 0 ]; then
              echo "✓ Container image built successfully"
              
              # Push the image
              echo "Pushing image to Docker Hub..."
              docker push "${CS_IMAGE_NAME}:${CS_IMAGE_TAG}"
              
              if [ $? -eq 0 ]; then
                echo "✓ Image pushed successfully"
                echo "success" > /tmp/build_status.txt
              else
                echo "✗ Image push failed"
                echo "push_failed" > /tmp/build_status.txt
              fi
            else
              echo "✗ Container image build failed"
              echo "failed" > /tmp/build_status.txt
            fi
      - persist_to_workspace:
          root: /tmp
          paths:
            - build_status.txt

  scan-container-image:
    executor: python-executor
    environment:
      FALCON_REGION: us-1
      CS_IMAGE_NAME: mile/spooky
      CS_IMAGE_TAG: latest
      DOCKER_USERNAME: mile
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Scan CrowdStrike Container Image
          no_output_timeout: 15m
          command: |
            set +x
            echo "Starting CrowdStrike Container Image Scan..."

            # Install required system packages
            echo "Installing system dependencies..."
            apt-get update && apt-get install -y \
              git \
              jq \
              docker.io \
              ca-certificates \
              curl

            # Install Python packages
            echo "Installing Python dependencies..."
            pip3 install --no-cache-dir --upgrade pip
            pip3 install --no-cache-dir \
              docker \
              crowdstrike-falconpy \
              retry

            # Wait for Docker to be ready
            echo "Waiting for Docker daemon to start..."
            for i in $(seq 1 45); do
              if docker info >/dev/null 2>&1; then
                echo "✓ Docker daemon is ready"
                break
              fi
              if [ $i -eq 45 ]; then
                echo "Error: Docker daemon failed to start after 90 seconds"
                echo "0" > /tmp/total_vulns.txt
                echo "0" > /tmp/critical_vulns.txt
                echo "0" > /tmp/high_vulns.txt
                echo "false" > /tmp/secrets_found.txt
                exit 0
              fi
              sleep 2
            done

            # Verify Docker is working
            echo "Verifying Docker installation..."
            docker --version
            docker info

            # Login to Docker Hub if credentials are provided
            if [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKERHUB_PASSWORD" ]; then
              echo "Logging into Docker Hub..."
              echo "$DOCKERHUB_PASSWORD" | docker login docker.io --username "$DOCKER_USERNAME" --password-stdin
            fi

            # Pull the image to scan
            echo "Pulling image to scan: ${CS_IMAGE_NAME}:${CS_IMAGE_TAG}"
            docker pull "${CS_IMAGE_NAME}:${CS_IMAGE_TAG}" || {
              echo "Warning: Failed to pull image, it may already exist locally or be inaccessible"
            }

            # Clone the container-image-scan repository
            echo "Cloning CrowdStrike container-image-scan repository..."
            if [ ! -d container-image-scan ]; then
              git clone https://github.com/crowdstrike/container-image-scan
            fi

            # Set environment variables for the scan
            export FALCON_CLIENT_SECRET="$FALCON_CLIENT_SECRET"
            export FALCON_CLIENT_ID="$FALCON_CLIENT_ID"
            export FALCON_CLOUD_REGION="$FALCON_REGION"

            echo ""
            echo "=== Scan Configuration ==="
            echo "Image: ${CS_IMAGE_NAME}:${CS_IMAGE_TAG}"
            echo "Region: $FALCON_REGION"
            echo "=========================="
            echo ""

            # Run the scan
            echo "Running container image scan..."
            set +e
            python3 container-image-scan/cs_scanimage.py \
              --repo "$CS_IMAGE_NAME" \
              --tag "$CS_IMAGE_TAG" \
              --cloud-region "$FALCON_REGION" \
              --json-report report.json
            scan_exit_code=$?
            set -e

            echo ""
            echo "Scan completed with exit code: $scan_exit_code"

            # Process the report
            if [ -f "report.json" ]; then
              echo "✓ Scan report generated"
              
              # Display report
              echo ""
              echo "=== Scan Report ==="
              cat report.json | jq '.' || cat report.json
              
              # Create remediation plan
              echo "# Vulnerability Remediation Plan" > remediation_plan.md
              echo "" >> remediation_plan.md
              echo "Generated: $(date)" >> remediation_plan.md
              echo "Image: ${CS_IMAGE_NAME}:${CS_IMAGE_TAG}" >> remediation_plan.md
              echo "" >> remediation_plan.md
              
              # Check for vulnerabilities
              if jq -e '.vulnerabilities' report.json > /dev/null 2>&1; then
                echo ""
                echo "Vulnerabilities found in the image:"
                jq -r '.vulnerabilities[] | select(.severity == "HIGH" or .severity == "CRITICAL") | "- \(.severity): \(.cve_id) in \(.package_name) \(.package_version)"' report.json || true
                
                echo "## High and Critical Vulnerabilities" >> remediation_plan.md
                jq -r '.vulnerabilities[] | select(.severity == "HIGH" or .severity == "CRITICAL") | "- **\(.severity)**: \(.cve_id) in \(.package_name) \(.package_version)\n  - Description: \(.description // "N/A")\n  - Remediation: Update to latest version or apply patch\n"' report.json >> remediation_plan.md || true
                
                # Count vulnerabilities
                TOTAL_VULNS=$(jq '[.vulnerabilities[]] | length' report.json || echo 0)
                CRITICAL_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' report.json || echo 0)
                HIGH_VULNS=$(jq '[.vulnerabilities[] | select(.severity == "HIGH")] | length' report.json || echo 0)
                
                echo ""
                echo "Vulnerability Summary:"
                echo "  Total: $TOTAL_VULNS"
                echo "  Critical: $CRITICAL_VULNS"
                echo "  High: $HIGH_VULNS"
                
                echo "$TOTAL_VULNS" > /tmp/total_vulns.txt
                echo "$CRITICAL_VULNS" > /tmp/critical_vulns.txt
                echo "$HIGH_VULNS" > /tmp/high_vulns.txt
              else
                echo "No vulnerabilities found"
                echo "0" > /tmp/total_vulns.txt
                echo "0" > /tmp/critical_vulns.txt
                echo "0" > /tmp/high_vulns.txt
              fi
              
              # Check for secrets
              if jq -e '.secrets' report.json > /dev/null 2>&1; then
                echo ""
                echo "WARNING: Secrets were detected in the image:"
                jq -r '.secrets[] | "- Secret type: \(.type) in \(.path)"' report.json || true
                
                echo "" >> remediation_plan.md
                echo "## Detected Secrets" >> remediation_plan.md
                jq -r '.secrets[] | "- Secret type: \(.type) found in \(.path)\n  - Action: Remove this secret and use secure storage methods instead\n"' report.json >> remediation_plan.md || true
                
                echo "true" > /tmp/secrets_found.txt
              else
                echo "No secrets were detected in the image"
                echo "false" > /tmp/secrets_found.txt
              fi
              
              # Display remediation plan
              echo ""
              echo "=== Remediation Plan ==="
              cat remediation_plan.md
              
            else
              echo "Error: Scan report not generated"
              echo "# No security findings to report" > remediation_plan.md
              
              echo "0" > /tmp/total_vulns.txt
              echo "0" > /tmp/critical_vulns.txt
              echo "0" > /tmp/high_vulns.txt
              echo "false" > /tmp/secrets_found.txt
            fi

            echo ""
            echo "✓ Container image scan completed"
      - persist_to_workspace:
          root: .
          paths:
            - report.json
            - remediation_plan.md
      - persist_to_workspace:
          root: /tmp
          paths:
            - total_vulns.txt
            - critical_vulns.txt
            - high_vulns.txt
            - secrets_found.txt

  process-container-results:
    executor: alpine-executor
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Process Container Scan Results
          command: |
            apk add --no-cache jq

            echo "=== Processing Container Scan Results ==="

            if [ ! -f report.json ]; then
              echo "No scan report found, checking for saved results..."
              
              if [ -f total_vulns.txt ]; then
                TOTAL=$(cat total_vulns.txt)
                CRITICAL=$(cat critical_vulns.txt)
                HIGH=$(cat high_vulns.txt)
                SECRETS_DETECTED=$(cat secrets_found.txt)
              else
                echo "No saved results found either"
                TOTAL=0
                CRITICAL=0
                HIGH=0
                SECRETS_DETECTED="false"
              fi
            else
              # Display report summary
              echo "Scan Report Summary:"
              cat report.json | jq '.' || cat report.json

              # Parse vulnerabilities
              TOTAL=$(jq '[.vulnerabilities[]] | length' report.json 2>/dev/null || echo 0)
              CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' report.json 2>/dev/null || echo 0)
              HIGH=$(jq '[.vulnerabilities[] | select(.severity == "HIGH")] | length' report.json 2>/dev/null || echo 0)
              MEDIUM=$(jq '[.vulnerabilities[] | select(.severity == "MEDIUM")] | length' report.json 2>/dev/null || echo 0)

              # Check for secrets
              SECRETS=$(jq '[.secrets[]] | length' report.json 2>/dev/null || echo 0)
              if [ "$SECRETS" -gt 0 ]; then
                SECRETS_DETECTED="true"
              else
                SECRETS_DETECTED="false"
              fi
            fi

            echo ""
            echo "=== Container Scan Summary ==="
            echo "Total Vulnerabilities: $TOTAL"
            echo "Critical: $CRITICAL"
            echo "High: $HIGH"
            echo "Secrets Detected: $SECRETS_DETECTED"

            echo "$TOTAL" > /tmp/vulnerabilities.txt
            echo "$CRITICAL" > /tmp/critical_vulns_final.txt
            echo "$HIGH" > /tmp/high_vulns_final.txt
            echo "$SECRETS_DETECTED" > /tmp/secrets_detected.txt
      - persist_to_workspace:
          root: /tmp
          paths:
            - vulnerabilities.txt
            - critical_vulns_final.txt
            - high_vulns_final.txt
            - secrets_detected.txt

  verify-app-dependencies:
    executor: node-executor
    environment:
      DOCKER_PORT: "3000"
    steps:
      - checkout
      - run:
          name: Verify Application Dependencies
          no_output_timeout: 10m
          command: |
            echo "Verifying Juice Shop application..."

            # Check if package.json exists
            if [ ! -f package.json ]; then
              echo "Error: package.json not found"
              echo "false" > /tmp/app_ready.txt
              exit 0
            fi

            echo "Installing dependencies..."
            npm install --production

            # Check available scripts
            echo ""
            echo "Available npm scripts:"
            npm run 2>&1 | grep -A 100 "Lifecycle scripts" || echo "No scripts found"

            # Run npm audit to show vulnerabilities
            echo ""
            echo "Running security audit..."
            npm audit --production || true

            echo ""
            echo "✓ Application dependencies verified"
            echo "Note: Application is containerized and runs via Docker"
            echo "true" > /tmp/app_ready.txt
      - persist_to_workspace:
          root: /tmp
          paths:
            - app_ready.txt

  security-summary:
    executor: alpine-executor
    environment:
      CS_IMAGE_NAME: mile/spooky
      CS_IMAGE_TAG: latest
      FCS_SCANNER_TAG: 2.1.5
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Security Summary Report
          command: |
            # Read values from workspace
            FINDINGS_COUNT=$(cat findings_count.txt 2>/dev/null || echo "0")
            CRITICAL_FINDINGS=$(cat critical_findings.txt 2>/dev/null || echo "0")
            HIGH_FINDINGS=$(cat high_findings.txt 2>/dev/null || echo "0")
            MEDIUM_FINDINGS=$(cat medium_findings.txt 2>/dev/null || echo "0")
            LOW_FINDINGS=$(cat low_findings.txt 2>/dev/null || echo "0")
            
            VULNERABILITIES=$(cat vulnerabilities.txt 2>/dev/null || echo "0")
            CRITICAL_VULNS=$(cat critical_vulns_final.txt 2>/dev/null || echo "0")
            HIGH_VULNS=$(cat high_vulns_final.txt 2>/dev/null || echo "0")
            SECRETS_DETECTED=$(cat secrets_detected.txt 2>/dev/null || echo "false")
            
            BUILD_STATUS=$(cat build_status.txt 2>/dev/null || echo "unknown")
            APP_READY=$(cat app_ready.txt 2>/dev/null || echo "unknown")

            echo "========================================="
            echo "  CROWDSTRIKE SECURITY SCAN SUMMARY"
            echo "========================================="
            echo ""
            echo "Pipeline: JuiceShop - FCS Pipeline"
            echo "Workflow: $CIRCLE_WORKFLOW_ID"
            echo "Build: $CIRCLE_BUILD_NUM"
            echo "Scanner: mile/cs-fcs:${FCS_SCANNER_TAG}"
            echo "Image Scanned: ${CS_IMAGE_NAME}:${CS_IMAGE_TAG}"
            echo ""
            echo "----------------------------------------"
            echo "IaC Scan Results:"
            echo "----------------------------------------"
            echo "  Total Findings: $FINDINGS_COUNT"
            echo "  Critical: $CRITICAL_FINDINGS"
            echo "  High: $HIGH_FINDINGS"
            echo "  Medium: $MEDIUM_FINDINGS"
            echo "  Informational: $LOW_FINDINGS"
            echo ""
            echo "----------------------------------------"
            echo "Container Image Scan Results:"
            echo "----------------------------------------"
            echo "  Total Vulnerabilities: $VULNERABILITIES"
            echo "  Critical: $CRITICAL_VULNS"
            echo "  High: $HIGH_VULNS"
            echo "  Secrets Detected: $SECRETS_DETECTED"
            echo ""
            echo "----------------------------------------"
            echo "Build & Deployment Status:"
            echo "----------------------------------------"
            echo "  Build Status: $BUILD_STATUS"
            echo "  App Ready: $APP_READY"
            echo ""
            echo "========================================="
            echo ""

            # Check if remediation plan exists
            if [ -f remediation_plan.md ]; then
              echo "Remediation Plan:"
              echo "----------------------------------------"
              cat remediation_plan.md
            fi

            echo ""
            echo "========================================="
            echo "Pipeline execution completed successfully"
            echo "========================================="
      - store_artifacts:
          path: remediation_plan.md
          destination: security-reports/remediation_plan.md
      - store_artifacts:
          path: report.json
          destination: security-reports/container_scan_report.json
      - store_artifacts:
          path: scansummary.txt
          destination: security-reports/iac_scan_summary.txt

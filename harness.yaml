pipeline:
  name: CrowdStrike Security Scanning Pipeline
  identifier: crowdstrike_security_scanning_pipeline
  projectIdentifier: <your_project_id>
  orgIdentifier: <your_org_id>
  tags: {}
  properties:
    ci:
      codebase:
        connectorRef: <your_git_connector>
        repoName: <your_repo_name>
        build: <+input>
  stages:
    - stage:
        name: Build
        identifier: Build
        type: CI
        spec:
          cloneCodebase: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Run
                  name: Install Node.js
                  identifier: install_nodejs
                  spec:
                    shell: Bash
                    command: |
                      curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
                      apt-get install -y nodejs
                      node --version
                      npm --version
              
              - step:
                  type: Run
                  name: Checkout Juice Shop Repo
                  identifier: checkout_juice_shop
                  spec:
                    shell: Bash
                    command: |
                      git clone <+pipeline.variables.JUICE_SHOP_REPO> juice-shop
                      cd juice-shop
              
              - step:
                  type: Run
                  name: Falcon Cloud Security IaC Scan
                  identifier: fcs_iac_scan
                  spec:
                    shell: Bash
                    envVariables:
                      CS_USERNAME: <+pipeline.variables.CS_USERNAME>
                      CS_PASSWORD: <+secrets.getValue("CS_PASSWORD")>
                      CS_REGISTRY: <+secrets.getValue("CS_REGISTRY")>
                      CS_IMAGE_NAME: <+pipeline.variables.CS_IMAGE_NAME>
                      CS_IMAGE_TAG: <+pipeline.variables.CS_IMAGE_TAG>
                      FALCON_CLIENT_ID: <+secrets.getValue("FALCON_CLIENT_ID")>
                      FALCON_CLIENT_SECRET: <+secrets.getValue("FALCON_CLIENT_SECRET")>
                      FALCON_REGION: <+pipeline.variables.FALCON_REGION>
                      PROJECT_PATH: <+pipeline.variables.PROJECT_PATH>
                    command: |
                      set +x
                      scan_status=0
                      
                      if [[ -z "$CS_USERNAME" || -z "$CS_PASSWORD" || -z "$CS_REGISTRY" || -z "$CS_IMAGE_NAME" || -z "$CS_IMAGE_TAG" || -z "$FALCON_CLIENT_ID" || -z "$FALCON_CLIENT_SECRET" || -z "$FALCON_REGION" || -z "$PROJECT_PATH" ]]; then
                          echo "Error: required environment variables/params are not set"
                          exit 1
                      else  
                          echo "Logging in to crowdstrike registry with username: $CS_USERNAME"
                          echo "$CS_PASSWORD" | docker login --username "$CS_USERNAME" --password-stdin
                          
                          if [ $? -eq 0 ]; then
                              echo "Docker login successful"
                              echo "Pulling fcs container target from crowdstrike"
                              docker pull $CS_IMAGE_NAME:$CS_IMAGE_TAG
                              
                              if [ $? -eq 0 ]; then
                                  echo "fcs docker container image pulled successfully"
                                  echo "=============== FCS IaC Scan Starts ==============="
                                  docker run --network=host --rm "$CS_IMAGE_NAME":"$CS_IMAGE_TAG" --client-id "$FALCON_CLIENT_ID" --client-secret "$FALCON_CLIENT_SECRET" --falcon-region "$FALCON_REGION" iac scan -p "$PROJECT_PATH" --upload-results | tee /harness/scansummary.txt
                                  scan_status=${PIPESTATUS[0]}
                                  echo "=============== FCS IaC Scan Ends ==============="
                                  echo "fcs-iac-scan-status: $scan_status"
                                  
                                  if [ $scan_status -eq 40 ]; then
                                      echo "Scan succeeded & vulnerabilities count are ABOVE the '--fail-on' threshold"
                                      exit 0
                                  elif [ $scan_status -eq 0 ]; then
                                      echo "Scan succeeded & vulnerabilities count are BELOW the '--fail-on' threshold"
                                      exit 0
                                  else
                                      echo "Unexpected scan exit code: $scan_status"
                                      exit 1
                                  fi
                              else
                                  echo "Error: failed to pull fcs docker image from crowdstrike"
                                  exit 1
                              fi
                          else
                              echo "Error: docker login failed"
                              exit 1
                          fi
                      fi
              
              - step:
                  type: Run
                  name: Process SARIF file
                  identifier: process_sarif
                  spec:
                    shell: Bash
                    command: |
                      if [ -f "/harness/scansummary.txt" ]; then
                        SARIFFILE=$(grep -o 'Results saved to file: [^ ]*' /harness/scansummary.txt | sed 's/Results saved to file: //')
                        
                        if [ -n "$SARIFFILE" ] && [ -f "$SARIFFILE" ]; then
                          echo "Found SARIF file: $SARIFFILE"
                          jq '.runs[].tool.driver.informationUri = "https://www.crowdstrike.com"' $SARIFFILE > /harness/results.sarif
                          echo "Successfully processed SARIF file to results.sarif"
                        else
                          echo "SARIF file not found in scan output, creating a minimal valid SARIF file"
                          echo '{
                            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
                            "version": "2.1.0",
                            "runs": [
                              {
                                "tool": {
                                  "driver": {
                                    "name": "CrowdStrike Falcon",
                                    "informationUri": "https://www.crowdstrike.com",
                                    "rules": []
                                  }
                                },
                                "results": []
                              }
                            ]
                          }' > /harness/results.sarif
                        fi
                      else
                        echo "Scan summary file not found, creating a minimal valid SARIF file"
                        echo '{
                          "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
                          "version": "2.1.0",
                          "runs": [
                            {
                              "tool": {
                                "driver": {
                                  "name": "CrowdStrike Falcon",
                                  "informationUri": "https://www.crowdstrike.com",
                                  "rules": []
                                }
                              },
                              "results": []
                            }
                          ]
                        }' > /harness/results.sarif
                      fi
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Return IAC Scan Summary
                  identifier: return_iac_summary
                  spec:
                    shell: Bash
                    command: |
                      if [ -f "/harness/scansummary.txt" ]; then
                        cat "/harness/scansummary.txt"
                      else
                        echo "Scan summary file not found"
                      fi
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Return IAC Sarif Results
                  identifier: return_sarif_results
                  spec:
                    shell: Bash
                    command: |
                      if [ -f "/harness/results.sarif" ]; then
                        cat "/harness/results.sarif"
                      else
                        echo "SARIF file not found"
                      fi
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: BuildAndPushDockerRegistry
                  name: Build container image
                  identifier: build_container
                  spec:
                    connectorRef: <your_docker_connector>
                    repo: <+pipeline.variables.CONTAINER_REPO>
                    tags:
                      - <+pipeline.variables.CONTAINER_TAG>
                    dockerfile: Dockerfile
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Scan container image with CrowdStrike
                  identifier: scan_container_image
                  spec:
                    shell: Bash
                    envVariables:
                      FALCON_CLIENT_SECRET: <+secrets.getValue("FALCON_CLIENT_SECRET")>
                      FALCON_CLIENT_ID: <+secrets.getValue("FALCON_CLIENT_ID")>
                    command: |
                      pip3 install docker crowdstrike-falconpy retry
                      
                      if [ ! -d container-image-scan ] ; then
                        git clone https://github.com/crowdstrike/container-image-scan
                      fi
                      
                      python3 container-image-scan/cs_scanimage.py --json-report /harness/report.json || true
                      
                      if [ -f "/harness/report.json" ]; then
                        echo "# Vulnerability Remediation Plan" > /harness/remediation_plan.md
                        
                        if jq -e '.vulnerabilities' /harness/report.json > /dev/null 2>&1; then
                          echo "Vulnerabilities found in the image:"
                          jq -r '.vulnerabilities[] | select(.severity == "HIGH" or .severity == "CRITICAL") | "- \(.severity): \(.cve_id) in \(.package_name) \(.package_version)"' /harness/report.json
                          
                          echo "## High and Critical Vulnerabilities" >> /harness/remediation_plan.md
                          jq -r '.vulnerabilities[] | select(.severity == "HIGH" or .severity == "CRITICAL") | "- **\(.severity)**: \(.cve_id) in \(.package_name) \(.package_version)\n  - Description: \(.description)\n  - Remediation: Update to latest version or apply patch"' /harness/report.json >> /harness/remediation_plan.md
                        fi
                        
                        if jq -e '.secrets' /harness/report.json > /dev/null 2>&1; then
                          echo "WARNING: Secrets were detected in the image:"
                          jq -r '.secrets[] | "- Secret type: \(.type) in \(.path)"' /harness/report.json
                          
                          echo "## Detected Secrets" >> /harness/remediation_plan.md
                          jq -r '.secrets[] | "- Secret type: \(.type) found in \(.path)\n  - Action: Remove this secret and use secure storage methods instead"' /harness/report.json >> /harness/remediation_plan.md
                        else
                          echo "No secrets were detected in the image."
                        fi
                      else
                        echo "Error: Scan report not generated."
                        echo "# No security findings to report" > /harness/remediation_plan.md
                      fi
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Print CrowdStrike Full Image Scan Report
                  identifier: print_scan_report
                  spec:
                    shell: Bash
                    command: |
                      if [ -f "/harness/report.json" ]; then
                        jq '.' /harness/report.json
                      else
                        echo "Image scan report not found"
                      fi
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Tag container image
                  identifier: tag_container
                  spec:
                    shell: Bash
                    envVariables:
                      CONTAINER_REPO: <+pipeline.variables.CONTAINER_REPO>
                      AZURE_CONTAINER_REGISTRY: <+pipeline.variables.azureContainerRegistry>
                    command: |
                      if [ -n "$CONTAINER_REPO" ] && [ -n "$AZURE_CONTAINER_REGISTRY" ]; then
                        docker tag $CONTAINER_REPO $AZURE_CONTAINER_REGISTRY/$CONTAINER_REPO
                        echo "Container image tagged successfully"
                      else
                        echo "Missing container repository or registry information"
                      fi
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Return API response from CrowdStrike Image Assessment
                  identifier: image_assessment
                  spec:
                    shell: Bash
                    envVariables:
                      FALCON_CLIENT_SECRET: <+secrets.getValue("FALCON_CLIENT_SECRET")>
                      FALCON_CLIENT_ID: <+secrets.getValue("FALCON_CLIENT_ID")>
                      API_BASE_URL: <+pipeline.variables.API_BASE_URL>
                      YOUR_CLOUD: <+pipeline.variables.YOUR_CLOUD>
                      CONTAINER_REPO: <+pipeline.variables.CONTAINER_REPO>
                      CONTAINER_TAG: <+pipeline.variables.CONTAINER_TAG>
                    command: |
                      if [ -z "$FALCON_CLIENT_SECRET" ] || [ -z "$FALCON_CLIENT_ID" ] || [ -z "$API_BASE_URL" ] || [ -z "$YOUR_CLOUD" ]; then
                        echo "Missing required environment variables for API call"
                        exit 0
                      fi
                      
                      RESPONSE=$(curl \
                        --header "Content-Type: application/x-www-form-urlencoded" \
                        --data "client_id=${FALCON_CLIENT_ID}&client_secret=${FALCON_CLIENT_SECRET}" \
                        --request POST \
                        --silent ${API_BASE_URL}/oauth2/token) 
                      CS_JWT=$(echo ${RESPONSE} | jq -r '.access_token')
                      
                      if [ -z "$CS_JWT" ] || [ "$CS_JWT" == "null" ]; then
                        echo "Failed to extract access token"
                        exit 0
                      fi
                      
                      ImageCheck=$(curl -s -X GET -H "authorization: Bearer ${CS_JWT}" \
                        "https://container-upload.${YOUR_CLOUD}/policy-checks?policy_type=image-prevention-policy&repository=$CONTAINER_REPO&tag=$CONTAINER_TAG")
                      
                      export test=$(echo $ImageCheck | jq '.resources[0].deny')
                      echo "Image assessment result: $test"
                    outputVariables:
                      - name: failBuild
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Build Application
                  identifier: build_app
                  spec:
                    shell: Bash
                    command: |
                      npm cache clean -f
                      npm install
                      nohup npm start > /dev/null 2>&1 &
                      sleep 5
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              
              - step:
                  type: Run
                  name: Deploy
                  identifier: deploy
                  spec:
                    shell: Bash
                    command: |
                      docker stop juice-shop || true
                      docker rm juice-shop || true
                      
                      docker build -t juice-shop .
                      CONTAINER_ID=$(docker run -d -P --name juice-shop juice-shop)
                      
                      if [ $? -eq 0 ]; then
                        DOCKER_HOST_PORT=$(docker port juice-shop 3000 | cut -d ':' -f 2)
                        
                        if [ -n "$DOCKER_HOST_PORT" ]; then
                          echo "Juice Shop is running on http://localhost:$DOCKER_HOST_PORT"
                        else
                          echo "Failed to get container port mapping"
                        fi
                      else
                        echo "Failed to start container"
                      fi
                    outputVariables:
                      - name: DOCKER_HOST_PORT
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
    
    - stage:
        name: PostDeployment
        identifier: PostDeployment
        type: CI
        spec:
          cloneCodebase: false
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Run
                  name: Success Notification
                  identifier: success_notification
                  spec:
                    shell: Bash
                    command: echo 'Build, test, and deployment successful!'
              
              - step:
                  type: Run
                  name: Security Findings Summary
                  identifier: security_summary
                  spec:
                    shell: Bash
                    command: |
                      echo "## Security Scan Summary"
                      echo ""
                      echo "### Container Image Scan"
                      
                      if [ -f "/harness/remediation_plan.md" ]; then
                        cat "/harness/remediation_plan.md"
                      else
                        echo "No remediation plan found. Container scan may have completed without findings."
                      fi
                      
                      echo ""
                      echo "### Next Steps"
                      echo "1. Review the security findings in the remediation plan"
                      echo "2. Address high and critical vulnerabilities"
                      echo "3. Remove any detected secrets from container images"
                      echo "4. Re-scan after remediation to verify fixes"
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
  
  variables:
    - name: JUICE_SHOP_REPO
      type: String
      value: https://github.com/mile9299/juice-shopv21.git
    - name: DOCKER_PORT
      type: String
      value: "3000"
    - name: CS_IMAGE_NAME
      type: String
      value: mile/cs-fcs
    - name: CS_IMAGE_TAG
      type: String
      value: 2.1.0
    - name: CS_USERNAME
      type: String
      value: mile
    - name: FALCON_REGION
      type: String
      value: us-1
    - name: PROJECT_PATH
      type: String
      value: git::https://github.com/ine-labs/AWSGoat.git
    - name: CONTAINER_REPO
      type: String
      value: <+input>
    - name: CONTAINER_TAG
      type: String
      value: <+input>
    - name: azureContainerRegistry
      type: String
      value: <+input>
    - name: API_BASE_URL
      type: String
      value: <+input>
    - name: YOUR_CLOUD
      type: String
      value: <+input>
